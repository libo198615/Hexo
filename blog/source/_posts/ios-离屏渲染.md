---
title: ios-离屏渲染
date: 2019-04-03 22:29:09
categories:
- iOS
tags:
---

OpenGL的中，GPU屏幕渲染有两种方式。 
屏幕渲染（当前屏幕渲染）

指的是GPU的渲染操作是在当前用于显示的屏幕缓冲区进行。

离屏渲染（离屏渲染）

指的是在GPU在当前屏幕缓冲区以外开辟一个缓冲区进行渲染操作。

显示器显示出来的图像是经过CRT电子枪一行一行的扫描。（可以是横向的也可以是纵向，具体CRT电子枪又是什么，百度文库介绍的很详细。），扫描出来就呈现了一帧画面，随后电子枪又会回到初始位置循环扫描，为了让显示器的显示跟视频控制器同步，当电子枪新扫描一行的时候。准备扫描的时候，会发送一个水平同步信号（HSync信号），显示器一般是固定刷新频率的，这个刷新的频率其实就是行同步信号产生的频率。然后CPU计算好帧等属性，就将计算好的内容提交给GPU去渲染，GPU渲染完成之后就会放入帧缓冲区，然后视频控制器会按照行同步信号逐行读取帧缓冲区的数据，经过可能的数模转换传递给显示器。就显示出来了。 
原理图就不放了，过一遍概念。

离屏渲染的代价很高，想要进行离屏渲染，首选要创建一个新的缓冲区，屏幕渲染会有一个上下文环境的一个概念，离屏渲染的整个过程需要切换上下文环境，先从当前显示幕切换到离屏，等结束后，又要将上下文环境切换回来。这也是为什么会消耗性能的原因了。 
。由于垂直同步的机制，如果在一个HSync时间内，CPU或GPU没有完成内容提交，则那一帧就会被丢弃，等待下一次机会再显示，而这时显示屏会保留之前的内容不变。这就是界面卡顿的原因。

那有个问题：为什么离屏渲染这么耗性能，为什么有这套机制呢？

当使用圆角，阴影，遮罩的时候，图层属性的混合体被指定为在未预合成之前（下一个HSync信号开始前）不能直接在屏幕中绘制，所以就需要屏幕外渲染