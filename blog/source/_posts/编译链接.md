---
title: 编译链接
date: 2019-01-06 20:39:50
categories:
- iOS
tags:
---



[^_^]: {% asset_img 1.png 图片说明 %}

![](https://ws2.sinaimg.cn/large/006tKfTcly1g0vdqctdgwj30k203zdfs.jpg)


程序中的源代码计算机是无法识别的，需要将其转成0、1二进制代码，计算机才能识别。将源代码转成二进制代码需要两步：编译和链接。

- 预处理：分析程序前先处理的语句，它可以识别散布在程序中的特定语句。所有的预处理语句都适用“＃”开头，这个符号必须是一行中的第一个非空字符。

预处理可以大概分为三类：文件包含、宏定义和条件编译。

1. 文件包含
文件包含：在当前文件中用到其它文件中的函数或方法或其它信息时，可以将其它文件的头文件包含进来，然后在当前文件中使用，文件包含一般放到文件的开头。
<>会先去找系统文件，如果找不到，再去找自定义文件。所以正确的选择样式，能够提高程序的执行效率。

2. 宏定义

3. 条件编译
条件编译主要分为两种：一种是判断是否定义过某个宏，根据是否定义过这个宏，来决定是否编译某段代码。另外，还有一组语句和条件结构中的阶梯if结构非常类似，但是写法上有区别，是#if、#elif、#else、#endif组成。需要注意的是，无论哪种，都要有#endif 结束标志。此外，最重要的一点是：条件编译中的条件不能使用普通变量，一般会选择使用宏定义。




- 编译是通过编译器将每个文件的代码都转为二进制代码，在这个过程中，如果有语法错误，会有编译失败的提示，如果成功，那么会生成对应多个目标文件。
- 在一个文件中可能会用到其他文件，因此，还需要将编译生成的目标文件和系统提供的文件组合到一起，这个过程就是链接。

##### main函数之前
- 系统先读取App的可执行文件(Mach-O文件)，从里面获得`dyld`的路径，然后加载`dyld`,`dyld`去初始化运行环境。

- 开启缓存策略，加载程序相关依赖库(其中也包含我们的可执行文件)，并对这些库进行链接，最后调用每个依赖库的初始化方法，在这一步，`runtime`被初始化。

- 当所有依赖库的初始化后，轮到最后一位(程序可执行文件)进行初始化，在这时`runtime`会对项目中所有类进行类机构初始化，然后调用所有的`load`方法。最后`dyld`返回`main`函数地址，`main`函数被调用，我们便来到程序入口`main`函数。
